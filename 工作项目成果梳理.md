# 工作项目成果梳理

## 1. 开发 HTTP 客户端以及对应的拦截器，实现在发送请求和接收响应时能通过指定的转换模板将 Body 中的数据转成目标格式的数据

1. 入口方法 RestWebServiceClientInvocation createRestWebServiceClientInvocation(Class<?> accessClassType, Object target)：遍历在 serviceContainer 中注册的 RestWebServiceClientInvocationProvider 实现类。
   * RestWebServiceClientInvocationProviderImpl（ 默认提供的 Provider ）
   * RetrofitClientInvocationProviderImpl（ 在指定的 accessClassType 中搜索 retrofit 专用的注解 ）

2. 实现 RestWebServiceClientInvocation 接口的两个实现类：RestWebServiceClientInvocationImpl 和 RetrofitClientInvocationImpl。核心方法 invoke() 的执行逻辑大致如下：
   1. 合法性检查，判断 invokeMethod 在目标 classType 中是否存在；
   2. 构建 RequestEntity 用于接收 HttpService 配置文件中的所有参数（ WebTarget、HttpMethod、ReturnType 等等 ），另外为了灵活性的考量引入 RequestContext 允许用户在正式发起 Http 请求前动态地去修改部分参数的值；
   3. 调用 Jersey 框架提供的 Invocation.Builder 接口，该接口的作用在完成资源定位配置后，向 REST 服务端发起请求的接口。通过 request() 方法构建 Http 请求，然后将逐次调用 headers()、accept() 以及 cookie() 方法将 RequestEntity 中的参数填充进去
   4. 最后调用 Invocation.Builder 接口的 method() 方法发起同步的 Http 请求。

3. Retrofit
   1. baseUrl：目标 URL；
   2. callFactory：用于构建 OkHttpClient 客户端；
   3. addConverterFactory：用于序列化和反序列化 JSON 数据；
   4. addCallAdapterFactory：自定义 DirectCallAdapterFactory 类（ 需要继承自 CallAdapter.Factory 类 ）就可以直接返回对应的 Java Bean。

## 2. 开发基于 FreeMarker 的宏函数库

为了解决不同 Yang 模型之间格式上的差异，传统的方式是采用硬编码来进行适配。这种方式的优点是更贴近开发人员，但缺点也很明显，可维护性差、不利于调试以及不支持热部署。因此现有框架的基础上引入 FreeMarker 来改善上述这些问题。利用 FreeMarker 语法设计并开发了如下几个宏函数：

   * `@exists`：用于读取来源数据中的字段，如果存在就回调该字段的值。
   > <#macro exists entity name defaultValue = "" notExpectedValue = "" expectedValue = "" callBack = "">

   * `@property`：用于简单的字段转换，把一个字段转成另一个字段。
   > <#macro property entity key name = key defaultValue = "" dataType = "" escapeString = true callBack = "">

   * `@enum`：用于转换来源数据中枚举类型的字段。
   > <#macro enum entity key type name = key defaultValue = "" callBack = "">

   * `@object`：用于对象模型的转换，是一组字段的集合。使用时需要指定子模板的路径名。
   > <#macro object entity key = "" templateName = "" name = key defaultValue = "" callBack = "">

   * `@list`：用于数组模型的转换，同样也需要指定子模板的路径名。
   > <#macro list entity key = "" templateName = "" name = key defaultValue = "" index = -1 callBack = "">
